service: sandcastle
image: sandcastle

ssh:
  user: thies

servers:
  web:
    hosts:
      - 100.65.155.100
    options:
      group-add: 988
      network: "name=sandcastle-web,alias=sandcastle-web"

volumes:
  - /var/run/docker.sock:/var/run/docker.sock
  - /data:/data
  - sandcastle-storage:/rails/storage

proxy:
  host: demo.sandcastle.rocks
  app_port: 80
  response_timeout: 60
  healthcheck:
    path: /up
  run:
    publish: false

registry:
  server: 100.126.147.91:4443
  username: kamal
  password:
    - KAMAL_REGISTRY_PASSWORD

env:
  clear:
    SANDCASTLE_HOST: demo.sandcastle.rocks
    SANDCASTLE_DATA_DIR: /data
  secret:
    - SECRET_KEY_BASE
    - RAILS_MASTER_KEY
    - GITHUB_CLIENT_ID
    - GITHUB_CLIENT_SECRET

builder:
  arch: amd64

accessories:
  traefik:
    image: traefik:v3.3
    host: 100.65.155.100
    port: "443:443"
    volumes:
      - /data/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - /data/traefik/dynamic:/data/dynamic:ro
      - /data/traefik/acme.json:/data/acme.json
    options:
      publish: "80:80"
      network: sandcastle-web
