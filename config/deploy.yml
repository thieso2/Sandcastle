service: sandcastle
image: thieso2/sandcastle

ssh:
  user: thies

servers:
  web:
    hosts:
      - 100.65.155.100
    options:
      group-add: 988
      network: "name=sandcastle-web,alias=sandcastle-web"

volumes:
  - /var/run/docker.sock:/var/run/docker.sock
  - /data:/data

proxy:
  host: demo.sandcastle.rocks
  app_port: 80
  response_timeout: 60
  healthcheck:
    path: /up
  run:
    publish: false

registry:
  server: ghcr.io
  username: thieso2
  password:
    - KAMAL_REGISTRY_PASSWORD

env:
  clear:
    SANDCASTLE_HOST: demo.sandcastle.rocks
    SANDCASTLE_DATA_DIR: /data
    DB_HOST: sandcastle-postgres
    DB_USER: sandcastle
  secret:
    - SECRET_KEY_BASE
    - RAILS_MASTER_KEY
    - DB_PASSWORD
    - GITHUB_CLIENT_ID
    - GITHUB_CLIENT_SECRET

builder:
  arch: amd64

accessories:
  postgres:
    image: postgres:18
    host: 100.65.155.100
    volumes:
      - /data/pgdata:/var/lib/postgresql
    env:
      clear:
        POSTGRES_USER: sandcastle
        POSTGRES_DB: sandcastle_production
      secret:
        - POSTGRES_PASSWORD
    options:
      network: sandcastle-web
      health-cmd: "pg_isready -U sandcastle -d sandcastle_production"
      health-interval: 5s
      health-timeout: 5s
      health-retries: "5"

  traefik:
    image: traefik:v3.3
    host: 100.65.155.100
    port: "443:443"
    volumes:
      - /data/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - /data/traefik/dynamic:/data/dynamic:ro
      - /data/traefik/acme.json:/data/acme.json
    options:
      publish: "80:80"
      network: sandcastle-web
