[tasks.dev]
description = "Create/migrate DB if needed, then start the dev server"
run = """
#!/usr/bin/env bash
set -euo pipefail
bin/rails db:prepare
bin/dev
"""

[tasks."deploy:local"]
description = "Build image and deploy locally via docker-compose.local.yml"
run = """
#!/usr/bin/env bash
set -euo pipefail

export BUILD_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "dev")
export BUILD_GIT_SHA=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
export BUILD_GIT_DIRTY=$([ -z "$(git status --porcelain 2>/dev/null)" ] && echo "" || echo "-dirty")
export BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)

echo "Building sandcastle:local ${BUILD_VERSION} (${BUILD_GIT_SHA}${BUILD_GIT_DIRTY})..."
docker compose -f docker-compose.local.yml build

echo "Starting services..."
docker compose -f docker-compose.local.yml up -d

echo ""
echo "Sandcastle running at http://localhost:${PORT:-3000}"
echo "Logs: docker compose -f docker-compose.local.yml logs -f"
"""

[tasks."deploy:local:down"]
description = "Stop local docker-compose deployment"
run = "docker compose -f docker-compose.local.yml down"

[tasks."deploy:local:logs"]
description = "Tail logs from local docker-compose deployment"
run = "docker compose -f docker-compose.local.yml logs -f"

[tasks."release"]
alias = "release:patch"
description = "Bump patch version, tag, push, and wait for CI to build the release"
run = """
#!/usr/bin/env bash
set -euo pipefail

# Get the latest tag
latest=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
echo "Current version: $latest"

# Parse and bump patch
IFS='.' read -r major minor patch <<< "${latest#v}"
new_version="v${major}.${minor}.$((patch + 1))"
echo "New version:     $new_version"

# Confirm
read -rp "Release $new_version? [y/N] " confirm
[[ "$confirm" =~ ^[Yy]$ ]] || { echo "Aborted."; exit 1; }

# Tag and push
git tag "$new_version"
git push origin "$new_version"
echo ""
echo "Tag $new_version pushed. GitHub Actions will build the release."
echo "https://github.com/thieso2/Sandcastle/actions"
"""

[tasks."release:minor"]
description = "Bump minor version, tag, push, and wait for CI to build the release"
run = """
#!/usr/bin/env bash
set -euo pipefail

latest=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
echo "Current version: $latest"

IFS='.' read -r major minor patch <<< "${latest#v}"
new_version="v${major}.$((minor + 1)).0"
echo "New version:     $new_version"

read -rp "Release $new_version? [y/N] " confirm
[[ "$confirm" =~ ^[Yy]$ ]] || { echo "Aborted."; exit 1; }

git tag "$new_version"
git push origin "$new_version"
echo ""
echo "Tag $new_version pushed. GitHub Actions will build the release."
echo "https://github.com/thieso2/Sandcastle/actions"
"""

[tasks."release:major"]
description = "Bump major version, tag, push, and wait for CI to build the release"
run = """
#!/usr/bin/env bash
set -euo pipefail

latest=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
echo "Current version: $latest"

IFS='.' read -r major minor patch <<< "${latest#v}"
new_version="v$((major + 1)).0.0"
echo "New version:     $new_version"

read -rp "Release $new_version? [y/N] " confirm
[[ "$confirm" =~ ^[Yy]$ ]] || { echo "Aborted."; exit 1; }

git tag "$new_version"
git push origin "$new_version"
echo ""
echo "Tag $new_version pushed. GitHub Actions will build the release."
echo "https://github.com/thieso2/Sandcastle/actions"
"""
