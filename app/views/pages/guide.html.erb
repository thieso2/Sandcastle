<% content_for(:title) { "Getting Started — Sandcastle" } %>

<div class="max-w-3xl mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold text-gray-900 mb-2">Getting Started</h1>
  <p class="text-gray-500 mb-8">Everything you need to go from zero to a running sandbox.</p>

  <% host = ENV.fetch("SANDCASTLE_HOST", "sandcastle.example.com") %>

  <%# ── Install ── %>
  <section class="mb-10">
    <h2 class="text-xl font-semibold text-gray-900 mb-3">1. Install the CLI</h2>
    <p class="text-gray-700 mb-3">
      Download the latest release from
      <%= link_to "GitHub Releases", "https://github.com/thieso2/Sandcastle/releases/latest", target: "_blank", class: "text-blue-600 hover:text-blue-800 underline" %>,
      then extract it:
    </p>
    <pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto text-sm leading-relaxed"><code>tar xzf sandcastle_*.tar.gz
sudo mv sandcastle /usr/local/bin/</code></pre>
  </section>

  <%# ── Login ── %>
  <section class="mb-10">
    <h2 class="text-xl font-semibold text-gray-900 mb-3">2. Log in</h2>
    <p class="text-gray-700 mb-3">Point the CLI at this server and authenticate via your browser:</p>
    <pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto text-sm leading-relaxed"><code>sandcastle login https://<%= host %></code></pre>
  </section>

  <%# ── Tailscale ── %>
  <section class="mb-10">
    <h2 class="text-xl font-semibold text-gray-900 mb-3">3. Enable Tailscale <span class="text-sm font-normal text-gray-500">(recommended)</span></h2>
    <p class="text-gray-700 mb-3">
      Each sandbox gets its own Tailscale IP so you can reach services directly — no port forwarding needed.
    </p>
    <pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto text-sm leading-relaxed"><code># Interactive login — opens a browser URL to authenticate
sandcastle tailscale enable

# Or use an auth key for headless setups
sandcastle tailscale enable --auth-key tskey-auth-...</code></pre>
    <p class="text-gray-500 text-sm mt-2">After authenticating, approve the advertised subnet routes in the Tailscale admin console.</p>
  </section>

  <%# ── Create ── %>
  <section class="mb-10">
    <h2 class="text-xl font-semibold text-gray-900 mb-3">4. Create a sandbox</h2>

    <p class="text-gray-700 mb-3"><strong>Web UI</strong> — click the "Create Sandcastle" button on your dashboard to create a sandbox with all available options:</p>
    <ul class="list-disc list-inside text-gray-700 ml-4 space-y-1 text-sm">
      <li><strong>Name</strong> — unique identifier for your sandbox</li>
      <li><strong>Container Image</strong> — custom image or default</li>
      <li><strong>Snapshot</strong> — restore from an existing snapshot</li>
      <li><strong>Persistent Volume</strong> — keep /workspace across recreations</li>
      <li><strong>Mount Home</strong> — persistent home directory across all sandboxes</li>
      <li><strong>Data Path</strong> — mount user data (or subpath) to /data</li>
      <li><strong>Tailscale</strong> — connect to your Tailscale network</li>
      <li><strong>Temporary</strong> — auto-remove when you disconnect</li>
    </ul>

    <p class="text-gray-700 mb-3 mt-4"><strong>Or use the CLI</strong> for quick creation:</p>

    <p class="text-gray-700 mb-3"><strong>Quick throwaway sandbox</strong> — deleted when you disconnect:</p>
    <pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto text-sm leading-relaxed"><code>sandcastle create scratch --rm</code></pre>

    <p class="text-gray-700 mb-3 mt-4"><strong>Persistent sandbox</strong> — keeps your home directory and data across restarts:</p>
    <pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto text-sm leading-relaxed"><code>sandcastle create my-dev --home --data</code></pre>

    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4 text-sm text-blue-800">
      <strong>Tip:</strong> Set environment variables to make flags the default:<br>
      <code class="bg-blue-100 px-1 rounded">export SANDCASTLE_HOME=1 SANDCASTLE_DATA=. SANDCASTLE_RM=1</code>
    </div>
  </section>

  <%# ── Connect ── %>
  <section class="mb-10">
    <h2 class="text-xl font-semibold text-gray-900 mb-3">5. Connect</h2>
    <p class="text-gray-700 mb-3">Two ways to get a shell:</p>
    <pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto text-sm leading-relaxed"><code># tmux session (reconnectable, auto-starts stopped sandboxes)
sandcastle connect my-dev

# Plain SSH
sandcastle ssh my-dev</code></pre>
  </section>

  <%# ── Web Terminal ── %>
  <section class="mb-10">
    <h2 class="text-xl font-semibold text-gray-900 mb-3">6. Web terminal</h2>
    <p class="text-gray-700 mb-3">
      Click the <strong>Terminal</strong> button on any running sandbox to open a browser-based shell.
      No SSH client needed — just a web browser.
    </p>
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
      <strong>How it works:</strong> Sandcastle spins up an ephemeral WeTTY container that auto-connects to your sandbox via SSH.
      The terminal session is protected by your existing login — no extra passwords required.
    </div>
  </section>

  <%# ── Browser ── %>
  <section class="mb-10">
    <h2 class="text-xl font-semibold text-gray-900 mb-3">7. Web browser</h2>
    <p class="text-gray-700 mb-3">
      Click the <strong>Browser</strong> button on any running sandbox to access Google Chrome with a graphical desktop environment.
      Perfect for browser automation, visual testing, or running GUI applications.
    </p>
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800 mb-3">
      <strong>How it works:</strong> Each sandbox includes Google Chrome, Xvfb (virtual X server), and x11vnc.
      Clicking Browser launches a noVNC container that connects to the sandbox's VNC server, giving you a full graphical browser in your web browser.
    </div>
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-sm text-green-800">
      <strong>Chrome profile persistence:</strong> Go to Settings → Browser to enable Chrome profile persistence.
      When enabled, your Chrome extensions, bookmarks, and settings are saved and persist across sandbox recreations.
      If you use <strong>Mount Home</strong>, profiles are stored in <code class="bg-green-100 px-1 rounded">~/.config/google-chrome</code> alongside all your other home directory files.
      Without Mount Home, profiles are stored separately in a dedicated directory.
    </div>
  </section>

  <%# ── Manage ── %>
  <section class="mb-10">
    <h2 class="text-xl font-semibold text-gray-900 mb-3">8. Manage sandboxes</h2>
    <pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto text-sm leading-relaxed"><code>sandcastle list              # Show all your sandboxes
sandcastle stop my-dev       # Stop a running sandbox
sandcastle start my-dev      # Start a stopped sandbox
sandcastle delete my-dev     # Permanently remove a sandbox</code></pre>
  </section>

  <%# ── Routes ── %>
  <section class="mb-10">
    <h2 class="text-xl font-semibold text-gray-900 mb-3">9. Custom domain routes</h2>
    <p class="text-gray-700 mb-3">
      Expose services running inside your sandbox on custom domains with automatic TLS.
      Each sandbox can have multiple routes pointing to different ports:
    </p>
    <pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto text-sm leading-relaxed"><code># Add a route — app.example.com → port 8080 (default) in sandbox "myapp"
sandcastle route add myapp app.example.com

# Add another route on a custom port
sandcastle route add myapp api.example.com 3000

# List all routes for a sandbox
sandcastle route list myapp

# Remove a specific route
sandcastle route delete myapp app.example.com</code></pre>
    <p class="text-gray-500 text-sm mt-2">Point a DNS A/CNAME record at <code class="bg-gray-100 px-1 rounded"><%= host %></code> before adding the route. TLS certificates are provisioned automatically via Let's Encrypt.</p>
  </section>

  <%# ── Snapshots ── %>
  <section class="mb-10">
    <h2 class="text-xl font-semibold text-gray-900 mb-3">10. Snapshots</h2>
    <p class="text-gray-700 mb-3">Save and restore the full state of a sandbox:</p>
    <pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto text-sm leading-relaxed"><code># Create a snapshot
sandcastle snapshot create my-dev my-checkpoint

# List snapshots
sandcastle snapshot list

# Restore into a new sandbox
sandcastle create my-dev-v2 --snapshot my-checkpoint</code></pre>
  </section>

  <%# ── Settings ── %>
  <section class="mb-10">
    <h2 class="text-xl font-semibold text-gray-900 mb-3">11. User settings</h2>
    <p class="text-gray-700 mb-3">
      Click <strong>Settings</strong> in the navbar to manage your account preferences:
    </p>
    <ul class="list-disc list-inside text-gray-700 ml-4 space-y-1 text-sm">
      <li><strong>Profile</strong> — Update your email address and change your password</li>
      <li><strong>Tailscale</strong> — View connection status and toggle auto-connect for new sandboxes</li>
      <li><strong>Browser</strong> — Toggle Chrome profile persistence across sandbox recreations</li>
      <li><strong>API Tokens</strong> — Create, list, and revoke multiple named API tokens for different devices or applications</li>
    </ul>
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4 text-sm text-blue-800">
      <strong>Using API tokens:</strong> Create tokens for different use cases (laptop, CI/CD, mobile).<br>
      <strong>Via Web UI:</strong> Go to Settings → click "New Token" → give it a name → copy the token<br>
      <strong>Via CLI:</strong> Run <code class="bg-blue-100 px-1 rounded">sandcastle token create laptop</code> to create a named token<br>
      <code class="bg-blue-100 px-1 rounded">sandcastle token list</code> to view all your tokens<br>
      <code class="bg-blue-100 px-1 rounded">sandcastle token revoke &lt;id&gt;</code> to revoke a specific token
    </div>
  </section>

  <%# ── Custom SSL Certificates ── %>
  <section class="mb-10">
    <h2 class="text-xl font-semibold text-gray-900 mb-3">12. Custom SSL certificates <span class="text-sm font-normal text-gray-500">(advanced)</span></h2>
    <p class="text-gray-700 mb-3">
      For internal networks, you can configure alternative hostnames with custom SSL certificates to avoid browser warnings.
    </p>

    <p class="text-gray-700 mb-3"><strong>Generate certificates with mkcert:</strong></p>
    <pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto text-sm leading-relaxed"><code># Install mkcert (macOS example)
brew install mkcert
mkcert -install

# Generate certificate for your domains
mkcert sandcastle.internal sc.local</code></pre>

    <p class="text-gray-700 mb-3 mt-4"><strong>Configure Sandcastle:</strong></p>
    <p class="text-gray-700 mb-3">Add these variables to your <code class="bg-gray-100 px-1.5 py-0.5 rounded">sandcastle.env</code> before installation:</p>
    <pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto text-sm leading-relaxed"><code>SANDCASTLE_ALT_HOSTNAMES=sandcastle.internal,sc.local
SANDCASTLE_CUSTOM_CERT_PATH=/path/to/sandcastle.internal+1.pem
SANDCASTLE_CUSTOM_KEY_PATH=/path/to/sandcastle.internal+1-key.pem
SANDCASTLE_TLS_MODE=selfsigned</code></pre>

    <p class="text-gray-700 mb-3 mt-4">The installer will copy the certificates to <code class="bg-gray-100 px-1.5 py-0.5 rounded">$SANDCASTLE_HOME/data/traefik/certs/</code> and configure Traefik to serve them for the specified hostnames.</p>

    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4 text-sm text-blue-800">
      <strong>Note:</strong> You'll need to add DNS entries (or edit <code class="bg-blue-100 px-1 rounded">/etc/hosts</code>) to point your alternative hostnames to the Sandcastle server IP.
    </div>
  </section>

  <div class="border-t border-gray-200 pt-6 text-center">
    <p class="text-sm text-gray-500">
      Run <code class="bg-gray-100 px-1.5 py-0.5 rounded">sandcastle --help</code> for the full command reference.
    </p>
  </div>
</div>
